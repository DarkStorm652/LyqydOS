local deskID = process.id()
local deskRedirect = process.windowCompositor:newBuffer()

local function getLws()
	for k,v in pairs(process.processTable) do
		if v.path == "lws" then
			return k
		end
	end
	return nil
end

--set up initial view.
local titlebarFillChar = deskRedirect.isColor() and " " or "="
deskRedirect.clear()
local x, y = deskRedirect.getSize()
deskRedirect.buffer.text[1] = titlebarFillChar.."LyqydOS"..string.rep(titlebarFillChar, x - 8)
if deskRedirect.isColor() then
	deskRedirect.buffer.textColor[1] = "fbbbbbbb"..string.rep("f", x - 8)
	deskRedirect.buffer.backColor[1] = string.rep("8", x)
	for i=2, y do
		deskRedirect.buffer.backColor[i] = string.rep("3", x)
	end
end

local titlebarItems
local tasksClickable

while true do
	local event = {os.pullEvent()}
	if event[1] == "redraw" then
		titlebarItems = {}
		for i=1, #process.processTable do
			if process.processTable[i] and process.processTable[i].window and not process.processTable[i].special then
				local tBarEntry = {pID = i, text = process.processTable[i].window.caption}
				table.insert(titlebarItems, tBarEntry)
			end
		end
		local taskText = ""
		tasksClickable = 0
		local usableWidth = x - 10
		for eNum, eInfo in ipairs(titlebarItems) do
			if #taskText + 9 > usableWidth then
				if #taskText > 9 then
					taskText = string.sub(taskText, 1, -10).."More... |"
				end
				break
			end
			local str = string.sub(eInfo.text, 1, 8)
			str = str..string.rep(" ", 8 - #str)
			if taskText == "" then taskText = "|" end
			taskText = taskText..str.."|"
			tasksClickable = tasksClickable + 1
		end
		deskRedirect.buffer.text[1] = titlebarFillChar.."LyqydOS"..titlebarFillChar..taskText..string.rep(titlebarFillChar, x - (#taskText + 9))
	elseif event[1] == "mouse_click" then
		if event[4] == 1 then
			--click on titlebar with no window covering it.
			if event[3] > 1 and event[3] < 9 and event[2] == 1 then
				--clicked on the LyqydOS button
				process.queueEvent(getLws(), "run_program")
			elseif event[3] > 9 then
				--clicked on task bar.
				clickItem = math.floor((event[3] - 1) / 9)
				if (event[3] - 10 ) % 9 ~= 0 and clickItem <= tasksClickable then
					--they clicked on the name itself, not the boundary line.
					if clickItem == tasksClickable and clickItem < #titlebarItems then
						--display the window choice dialog
						if process.processTable[process.focusWindow] then
							process.queueEvent(getLws(), "select_window")
						end
					else
						if process.focusWindow ~= titlebarItems[clickItem].pID then
							process.focusWindow = titlebarItems[clickItem].pID
						end
						process.toFront(process.focusWindow)
						if process.processTable[process.focusWindow].window.minimized then process.processTable[process.focusWindow].window:unMinimize() end
						if event[2] == 2 then
							--they right-clicked, so let's also display the window action menu.
							process.queueEvent(getLws(), "window_action", process.focusWindow, process.processTable[process.focusWindow].window)
						end
					end
				end
			end
		end
	end
end